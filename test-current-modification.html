<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Current Modification Test</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/components.css" />
  </head>
  <body>
    <div id="test-container">
      <h1>Testing Current Patient Modification Implementation</h1>
      <div id="test-results"></div>
      <div id="patient-detail-container"></div>
    </div>

    <!-- Load all required scripts -->
    <script src="js/utils/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/validation.js"></script>
    <script src="js/models/Patient.js"></script>
    <script src="js/components/DataStorageManager.js"></script>
    <script src="js/components/PatientManager.js"></script>
    <script src="js/components/FormManager.js"></script>
    <script src="js/components/PatientDetailView.js"></script>

    <script>
      async function testCurrentImplementation() {
        const testResults = document.getElementById("test-results");
        const container = document.getElementById("patient-detail-container");

        try {
          testResults.innerHTML =
            "<p>üß™ Testing current patient modification implementation...</p>";

          // Initialize components
          const dataStorage = new DataStorageManager();
          await dataStorage.initializeStorage();

          const patientManager = new PatientManager();
          await patientManager.initialize(dataStorage);

          // Create test patient
          const testPatientData = {
            firstName: "Test",
            lastName: "Patient",
            dateOfBirth: "1985-05-15",
            age: 39,
            placeOfResidence: "Test City",
            gender: "female",
            visits: [
              {
                visitDate: "2024-01-15",
                medications: "Test medication",
                observations: "Test observations",
                additionalComments: "Test comments",
              },
            ],
          };

          const createResult = await patientManager.createPatient(
            testPatientData
          );
          const patient = await patientManager.getPatient(
            createResult.patientId
          );

          // Create PatientDetailView
          const patientDetailView = new PatientDetailView(
            patient,
            patientManager
          );

          // Test 1: Check if edit functionality exists
          testResults.innerHTML +=
            "<p>‚úÖ PatientDetailView created successfully</p>";

          // Test 2: Check if handleEdit method exists
          if (typeof patientDetailView.handleEdit === "function") {
            testResults.innerHTML += "<p>‚úÖ handleEdit method exists</p>";
          } else {
            throw new Error("handleEdit method missing");
          }

          // Test 3: Check if handleSave method exists
          if (typeof patientDetailView.handleSave === "function") {
            testResults.innerHTML += "<p>‚úÖ handleSave method exists</p>";
          } else {
            throw new Error("handleSave method missing");
          }

          // Test 4: Check if change tracking exists
          if (typeof patientDetailView.hasUnsavedChanges === "function") {
            testResults.innerHTML +=
              "<p>‚úÖ hasUnsavedChanges method exists</p>";
          } else {
            throw new Error("hasUnsavedChanges method missing");
          }

          // Test 5: Check if PatientManager has updatePatient method
          if (typeof patientManager.updatePatient === "function") {
            testResults.innerHTML +=
              "<p>‚úÖ PatientManager.updatePatient method exists</p>";
          } else {
            throw new Error("PatientManager.updatePatient method missing");
          }

          // Test 6: Test actual edit mode toggle
          patientDetailView.handleEdit();
          if (patientDetailView.isEditMode) {
            testResults.innerHTML += "<p>‚úÖ Edit mode toggle works</p>";
          } else {
            throw new Error("Edit mode toggle failed");
          }

          // Test 7: Test rendering in edit mode
          container.innerHTML = patientDetailView.render();
          if (container.innerHTML.includes("Save Changes")) {
            testResults.innerHTML += "<p>‚úÖ Edit mode renders correctly</p>";
          } else {
            throw new Error("Edit mode rendering failed");
          }

          testResults.innerHTML +=
            "<p><strong>üéâ Current implementation appears to be working!</strong></p>";
          testResults.innerHTML +=
            "<p>The patient modification functionality is already implemented.</p>";
        } catch (error) {
          testResults.innerHTML += `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
          console.error("Test error:", error);
        }
      }

      window.addEventListener("load", testCurrentImplementation);
    </script>
  </body>
</html>
