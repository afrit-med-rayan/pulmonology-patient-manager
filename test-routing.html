<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UI Router Test - Patient Management System</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <style>
      .test-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .test-section {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 20px;
        margin-bottom: 20px;
      }

      .test-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 20px 0;
      }

      .route-info {
        background: var(--bg-secondary);
        padding: 15px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: 14px;
        margin: 10px 0;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-indicator.success {
        background-color: var(--accent-color);
      }

      .status-indicator.error {
        background-color: var(--danger-color);
      }

      .status-indicator.warning {
        background-color: var(--warning-color);
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>UI Router Test Page</h1>
      <p>
        This page tests the UIRouter functionality for the Patient Management
        System.
      </p>

      <div class="test-section">
        <h2>Router Status</h2>
        <div id="router-status">
          <span class="status-indicator error"></span>
          Router not initialized
        </div>
        <div class="route-info" id="current-route">
          Current Route: Not available
        </div>
      </div>

      <div class="test-section">
        <h2>Navigation Tests</h2>
        <div class="test-buttons">
          <button class="btn btn-primary" onclick="testNavigation('dashboard')">
            Go to Dashboard
          </button>
          <button
            class="btn btn-primary"
            onclick="testNavigation('create-patient')"
          >
            Go to Create Patient
          </button>
          <button
            class="btn btn-primary"
            onclick="testNavigation('search-patients')"
          >
            Go to Search Patients
          </button>
          <button
            class="btn btn-primary"
            onclick="testNavigation('patient-list')"
          >
            Go to Patient List
          </button>
          <button
            class="btn btn-primary"
            onclick="testNavigation('patient-detail', {patientId: 'test-123'})"
          >
            Go to Patient Detail
          </button>
          <button
            class="btn btn-secondary"
            onclick="testNavigation('non-existent-route')"
          >
            Test 404 Route
          </button>
        </div>
      </div>

      <div class="test-section">
        <h2>Browser Navigation Tests</h2>
        <div class="test-buttons">
          <button class="btn btn-secondary" onclick="testBrowserBack()">
            Browser Back
          </button>
          <button class="btn btn-secondary" onclick="testBrowserForward()">
            Browser Forward
          </button>
          <button class="btn btn-secondary" onclick="testHashChange()">
            Test Hash Change
          </button>
        </div>
      </div>

      <div class="test-section">
        <h2>Unsaved Changes Tests</h2>
        <div class="test-buttons">
          <button class="btn btn-warning" onclick="simulateUnsavedChanges()">
            Simulate Unsaved Changes
          </button>
          <button class="btn btn-success" onclick="clearUnsavedChanges()">
            Clear Unsaved Changes
          </button>
          <button class="btn btn-primary" onclick="testNavigationWithChanges()">
            Navigate with Changes
          </button>
        </div>
        <div id="changes-status" class="route-info">Unsaved Changes: None</div>
      </div>

      <div class="test-section">
        <h2>Route History</h2>
        <div id="route-history" class="route-info">
          No navigation history yet
        </div>
      </div>

      <div class="test-section">
        <h2>Test Results</h2>
        <div id="test-results">
          <p>Run tests to see results here...</p>
        </div>
      </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-container hidden"></div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- JavaScript Files -->
    <script src="js/utils/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/components/ErrorHandler.js"></script>
    <script src="js/components/ChangeTracker.js"></script>
    <script src="js/components/ModalManager.js"></script>
    <script src="js/components/UIRouter.js"></script>

    <script>
      // Test variables
      let router;
      let modalManager;
      let changeTracker;
      let errorHandler;
      let testResults = [];
      let hasUnsavedChanges = false;

      // Initialize test environment
      function initializeTest() {
        try {
          // Initialize components
          errorHandler = new ErrorHandler();
          changeTracker = new ChangeTracker();
          modalManager = new ModalManager();
          router = new UIRouter();

          // Override router methods for testing
          setupTestRoutes();

          // Update status
          updateRouterStatus(true);
          updateCurrentRoute();

          // Set up change tracking simulation
          setupChangeTracking();

          logResult("success", "Test environment initialized successfully");
        } catch (error) {
          logResult(
            "error",
            "Failed to initialize test environment: " + error.message
          );
          updateRouterStatus(false, error.message);
        }
      }

      function setupTestRoutes() {
        // Override route handlers for testing
        router.registerRoute(
          "dashboard",
          async (route, params) => {
            logResult("info", `Navigated to dashboard`);
            updateTestContent("Dashboard View", "Welcome to the dashboard");
          },
          { title: "Dashboard" }
        );

        router.registerRoute(
          "create-patient",
          async (route, params) => {
            logResult("info", `Navigated to create-patient`);
            updateTestContent(
              "Create Patient View",
              "Patient creation form would be here"
            );
          },
          { title: "Create Patient" }
        );

        router.registerRoute(
          "search-patients",
          async (route, params) => {
            logResult("info", `Navigated to search-patients`);
            updateTestContent(
              "Search Patients View",
              "Patient search interface would be here"
            );
          },
          { title: "Search Patients" }
        );

        router.registerRoute(
          "patient-list",
          async (route, params) => {
            logResult("info", `Navigated to patient-list`);
            updateTestContent(
              "Patient List View",
              "List of all patients would be here"
            );
          },
          { title: "Patient List" }
        );

        router.registerRoute(
          "patient-detail",
          async (route, params) => {
            logResult(
              "info",
              `Navigated to patient-detail with params:`,
              params
            );
            updateTestContent(
              "Patient Detail View",
              `Patient details for ID: ${params.patientId || "unknown"}`
            );
          },
          { title: "Patient Details" }
        );

        router.registerRoute(
          "not-found",
          async (route, params) => {
            logResult(
              "warning",
              `404 - Route not found: ${params.originalRoute}`
            );
            updateTestContent(
              "404 Not Found",
              `The route "${params.originalRoute}" was not found`
            );
          },
          { title: "Page Not Found", requiresAuth: false }
        );
      }

      function setupChangeTracking() {
        // Override change tracking methods for testing
        window.app = {
          components: {
            changeTracker: {
              hasUnsavedChanges: () => hasUnsavedChanges,
              getChangeDetails: () => ({
                hasChanges: hasUnsavedChanges,
                totalChanges: hasUnsavedChanges ? 3 : 0,
                descriptions: hasUnsavedChanges
                  ? ["Test form data", "Patient information"]
                  : [],
              }),
              saveAllChanges: async () => {
                logResult("info", "Saving all changes...");
                hasUnsavedChanges = false;
                updateChangesStatus();
              },
              discardAllChanges: () => {
                logResult("info", "Discarding all changes...");
                hasUnsavedChanges = false;
                updateChangesStatus();
              },
            },
            modalManager: modalManager,
          },
        };
      }

      function updateTestContent(title, content) {
        // Create or update test content area
        let contentArea = document.getElementById("test-content-area");
        if (!contentArea) {
          contentArea = document.createElement("div");
          contentArea.id = "test-content-area";
          contentArea.className = "test-section";
          document.querySelector(".test-container").appendChild(contentArea);
        }

        contentArea.innerHTML = `
                <h2>${title}</h2>
                <p>${content}</p>
                <p><small>Route loaded at: ${new Date().toLocaleTimeString()}</small></p>
            `;
      }

      function updateRouterStatus(isInitialized, error = null) {
        const statusElement = document.getElementById("router-status");
        const indicator = statusElement.querySelector(".status-indicator");

        if (isInitialized) {
          indicator.className = "status-indicator success";
          statusElement.innerHTML =
            '<span class="status-indicator success"></span>Router initialized successfully';
        } else {
          indicator.className = "status-indicator error";
          statusElement.innerHTML = `<span class="status-indicator error"></span>Router initialization failed${
            error ? ": " + error : ""
          }`;
        }
      }

      function updateCurrentRoute() {
        if (!router) return;

        const routeInfo = router.getCurrentRoute();
        const routeElement = document.getElementById("current-route");

        routeElement.textContent = `Current Route: ${
          routeInfo.route || "none"
        } | Params: ${JSON.stringify(routeInfo.params)} | Hash: ${
          window.location.hash
        }`;
      }

      function updateChangesStatus() {
        const statusElement = document.getElementById("changes-status");
        statusElement.textContent = `Unsaved Changes: ${
          hasUnsavedChanges ? "Yes (simulated)" : "None"
        }`;
      }

      function updateRouteHistory() {
        if (!router) return;

        const historyElement = document.getElementById("route-history");
        const history = router.navigationHistory || [];

        if (history.length === 0) {
          historyElement.textContent = "No navigation history yet";
        } else {
          const historyText = history
            .slice(-5)
            .map(
              (item) =>
                `${item.route}${
                  Object.keys(item.params).length > 0
                    ? " (" + JSON.stringify(item.params) + ")"
                    : ""
                }`
            )
            .join(" → ");
          historyElement.textContent = `Recent: ${historyText}`;
        }
      }

      // Test functions
      async function testNavigation(route, params = {}) {
        if (!router) {
          logResult("error", "Router not initialized");
          return;
        }

        try {
          logResult("info", `Testing navigation to: ${route}`, params);
          const success = await router.navigateTo(route, params);

          if (success) {
            logResult("success", `Successfully navigated to: ${route}`);
          } else {
            logResult(
              "warning",
              `Navigation to ${route} was cancelled or failed`
            );
          }

          updateCurrentRoute();
          updateRouteHistory();
        } catch (error) {
          logResult("error", `Navigation error: ${error.message}`);
        }
      }

      function testBrowserBack() {
        logResult("info", "Testing browser back button");
        window.history.back();
        setTimeout(updateCurrentRoute, 100);
      }

      function testBrowserForward() {
        logResult("info", "Testing browser forward button");
        window.history.forward();
        setTimeout(updateCurrentRoute, 100);
      }

      function testHashChange() {
        logResult("info", "Testing hash change");
        window.location.hash = "#test-hash-" + Date.now();
        setTimeout(updateCurrentRoute, 100);
      }

      function simulateUnsavedChanges() {
        hasUnsavedChanges = true;
        updateChangesStatus();
        logResult("info", "Simulated unsaved changes");
      }

      function clearUnsavedChanges() {
        hasUnsavedChanges = false;
        updateChangesStatus();
        logResult("info", "Cleared unsaved changes");
      }

      async function testNavigationWithChanges() {
        if (!hasUnsavedChanges) {
          simulateUnsavedChanges();
        }

        logResult("info", "Testing navigation with unsaved changes");
        await testNavigation("dashboard");
      }

      function logResult(type, message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const result = { type, message, data, timestamp };
        testResults.push(result);

        // Update results display
        const resultsElement = document.getElementById("test-results");
        const resultHtml = testResults
          .slice(-10)
          .map((r) => {
            const icon =
              {
                success: "✅",
                error: "❌",
                warning: "⚠️",
                info: "ℹ️",
              }[r.type] || "ℹ️";

            return `<div class="test-result ${r.type}">
                    ${icon} [${r.timestamp}] ${r.message}
                    ${
                      r.data
                        ? "<br><small>" + JSON.stringify(r.data) + "</small>"
                        : ""
                    }
                </div>`;
          })
          .join("");

        resultsElement.innerHTML = resultHtml;

        console.log(`[${type.toUpperCase()}] ${message}`, data);
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", initializeTest);

      // Update route info on hash changes
      window.addEventListener("hashchange", () => {
        setTimeout(() => {
          updateCurrentRoute();
          updateRouteHistory();
        }, 100);
      });
    </script>
  </body>
</html>
