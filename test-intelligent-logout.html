<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Intelligent Logout System</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/layout.css" />
  </head>
  <body>
    <div id="app">
      <!-- Main Application Content -->
      <main id="main-content">
        <header class="header">
          <div class="header-container">
            <div class="logo-container">
              <h1 class="logo-text">Dr. S. Sahboub</h1>
            </div>
            <div class="header-actions">
              <span class="user-info">Welcome, Dr. S. Sahboub</span>
              <button
                class="btn btn-secondary logout-btn"
                onclick="testLogout()"
              >
                Logout
              </button>
            </div>
          </div>
        </header>

        <div class="main-container">
          <div class="content-header">
            <h1 class="content-title">Test Intelligent Logout System</h1>
            <p class="content-subtitle">
              Test the logout confirmation dialog with unsaved changes
            </p>
          </div>

          <!-- Test Form -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Test Patient Form</h3>
            </div>
            <div class="card-body">
              <form id="test-patient-form" class="patient-form">
                <div class="form-section">
                  <h3 class="form-section-title">Personal Information</h3>

                  <div class="form-row">
                    <div class="form-group">
                      <label for="firstName" class="form-label">
                        First Name <span class="required">*</span>
                      </label>
                      <input
                        type="text"
                        id="firstName"
                        name="firstName"
                        class="form-control"
                        placeholder="Enter first name"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="lastName" class="form-label">
                        Last Name <span class="required">*</span>
                      </label>
                      <input
                        type="text"
                        id="lastName"
                        name="lastName"
                        class="form-control"
                        placeholder="Enter last name"
                        required
                      />
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea
                      id="notes"
                      name="notes"
                      class="form-control"
                      rows="4"
                      placeholder="Enter notes"
                    ></textarea>
                  </div>
                </div>

                <div class="form-actions">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="clearForm()"
                  >
                    Clear Form
                  </button>
                  <button type="submit" class="btn btn-primary">
                    Save Patient
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Test Instructions -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Test Instructions</h3>
            </div>
            <div class="card-body">
              <ol>
                <li>Fill in some information in the form above</li>
                <li>Click the "Logout" button</li>
                <li>
                  You should see a modal with three options:
                  <ul>
                    <li>
                      <strong>Save and Exit</strong> - Saves changes and logs
                      out
                    </li>
                    <li>
                      <strong>Exit Without Saving</strong> - Logs out without
                      saving
                    </li>
                    <li>
                      <strong>Cancel</strong> - Returns to the application
                    </li>
                  </ul>
                </li>
                <li>If the form is empty, logout should happen immediately</li>
              </ol>

              <div style="margin-top: 20px">
                <button class="btn btn-primary" onclick="simulateChanges()">
                  Simulate Form Changes
                </button>
                <button class="btn btn-secondary" onclick="clearChanges()">
                  Clear All Changes
                </button>
                <button class="btn btn-info" onclick="checkChanges()">
                  Check for Changes
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Modal Container -->
    <div id="modal-container" class="modal-container hidden"></div>

    <!-- JavaScript Files -->
    <script src="js/utils/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/validation.js"></script>
    <script src="js/models/Patient.js"></script>
    <script src="js/models/Session.js"></script>
    <script src="js/components/ErrorHandler.js"></script>
    <script src="js/components/ChangeTracker.js"></script>
    <script src="js/components/ModalManager.js"></script>
    <script src="js/components/FormManager.js"></script>

    <script>
      // Initialize components for testing
      let changeTracker, modalManager, formManager;

      // Initialize test environment
      function initializeTest() {
        try {
          console.log("Initializing test environment...");

          // Initialize components
          changeTracker = new ChangeTracker();
          modalManager = new ModalManager();
          formManager = new FormManager();

          // Track the test form
          changeTracker.trackForm("test-patient-form", {
            displayName: "Test Patient Form",
            description: "Test form for logout functionality",
          });

          // Initialize the form
          formManager.initializeForm("test-patient-form", {
            displayName: "Test Patient Form",
          });

          // Set up form submission handler
          document
            .getElementById("test-patient-form")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              alert("Form submitted! (This is just a test)");
              changeTracker.markFormAsSaved("test-patient-form");
            });

          console.log("Test environment initialized successfully");
        } catch (error) {
          console.error("Error initializing test:", error);
          alert("Error initializing test: " + error.message);
        }
      }

      // Test logout function
      async function testLogout() {
        try {
          console.log("Testing logout...");

          // Check for unsaved changes
          const hasChanges = changeTracker.hasUnsavedChanges();
          console.log("Has unsaved changes:", hasChanges);

          if (!hasChanges) {
            // No changes, logout immediately
            alert("No unsaved changes detected. Logging out immediately.");
            console.log("Logout completed (no changes)");
            return;
          }

          // Get change details
          const details = changeTracker.getUnsavedChangesDetails();
          console.log("Change details:", details);

          // Show logout confirmation modal
          const userChoice = await modalManager.showLogoutConfirmation({
            changesDetails: details.descriptions,
          });

          console.log("User choice:", userChoice);

          switch (userChoice) {
            case "save-and-exit":
              alert("Saving changes and logging out...");
              // Simulate save
              changeTracker.markAllAsSaved();
              console.log("Saved and logged out");
              break;

            case "exit-without-saving":
              alert("Logging out without saving changes...");
              changeTracker.clearAllTracking();
              console.log("Logged out without saving");
              break;

            case "cancel":
              alert("Logout cancelled");
              console.log("Logout cancelled by user");
              break;

            default:
              console.log("Unknown choice:", userChoice);
              break;
          }
        } catch (error) {
          console.error("Error during logout test:", error);
          alert("Error during logout: " + error.message);
        }
      }

      // Helper functions for testing
      function simulateChanges() {
        document.getElementById("firstName").value = "John";
        document.getElementById("lastName").value = "Doe";
        document.getElementById("notes").value = "Test patient notes";

        // Trigger change events
        ["firstName", "lastName", "notes"].forEach((id) => {
          const element = document.getElementById(id);
          element.dispatchEvent(new Event("input", { bubbles: true }));
        });

        alert("Form changes simulated");
      }

      function clearForm() {
        document.getElementById("test-patient-form").reset();

        // Trigger change events
        ["firstName", "lastName", "notes"].forEach((id) => {
          const element = document.getElementById(id);
          element.dispatchEvent(new Event("input", { bubbles: true }));
        });

        alert("Form cleared");
      }

      function clearChanges() {
        changeTracker.markAllAsSaved();
        alert("All changes marked as saved");
      }

      function checkChanges() {
        const hasChanges = changeTracker.hasUnsavedChanges();
        const details = changeTracker.getUnsavedChangesDetails();

        alert(
          `Has changes: ${hasChanges}\nDetails: ${JSON.stringify(
            details,
            null,
            2
          )}`
        );
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", initializeTest);
    </script>
  </body>
</html>
