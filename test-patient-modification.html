<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Modification Test</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/components.css" />
  </head>
  <body>
    <div id="test-container">
      <h1>Patient Modification Test</h1>
      <div id="test-results"></div>
      <div id="patient-detail-container"></div>
    </div>

    <!-- Load all required scripts -->
    <script src="js/utils/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/models/Patient.js"></script>
    <script src="js/components/DataStorageManager.js"></script>
    <script src="js/components/PatientManager.js"></script>
    <script src="js/components/FormManager.js"></script>
    <script src="js/components/PatientDetailView.js"></script>

    <script>
      // Test patient modification functionality
      async function testPatientModification() {
        const testResults = document.getElementById("test-results");
        const container = document.getElementById("patient-detail-container");

        try {
          testResults.innerHTML =
            "<p>üß™ Starting Patient Modification Tests...</p>";

          // Initialize components
          const dataStorage = new DataStorageManager();
          await dataStorage.initializeStorage();

          const patientManager = new PatientManager();
          await patientManager.initialize(dataStorage);

          // Create test patient
          const testPatientData = {
            firstName: "John",
            lastName: "Doe",
            dateOfBirth: "1980-01-15",
            age: 44,
            placeOfResidence: "New York",
            gender: "male",
            visits: [
              {
                visitDate: "2024-01-15",
                medications: "Albuterol inhaler",
                observations: "Mild wheezing",
                additionalComments: "Patient reports improvement",
              },
            ],
          };

          // Create patient
          const createResult = await patientManager.createPatient(
            testPatientData
          );
          if (!createResult.success) {
            throw new Error("Failed to create test patient");
          }

          // Load patient
          const patient = await patientManager.getPatient(
            createResult.patientId
          );
          if (!patient) {
            throw new Error("Failed to load test patient");
          }

          testResults.innerHTML += "<p>‚úÖ Test patient created and loaded</p>";

          // Create PatientDetailView
          const patientDetailView = new PatientDetailView(
            patient,
            patientManager
          );

          // Test 1: Render view mode
          container.innerHTML = patientDetailView.render();
          if (!container.innerHTML.includes("Edit Patient")) {
            throw new Error("View mode not rendered correctly");
          }
          testResults.innerHTML += "<p>‚úÖ View mode renders correctly</p>";

          // Test 2: Enter edit mode
          patientDetailView.handleEdit();
          if (!patientDetailView.isEditMode) {
            throw new Error("Failed to enter edit mode");
          }
          testResults.innerHTML += "<p>‚úÖ Edit mode activated</p>";

          // Test 3: Render edit mode
          container.innerHTML = patientDetailView.render();
          if (!container.innerHTML.includes("Save Changes")) {
            throw new Error("Edit mode not rendered correctly");
          }
          testResults.innerHTML += "<p>‚úÖ Edit mode renders correctly</p>";

          // Test 4: Check unsaved changes detection
          if (patientDetailView.hasUnsavedChanges()) {
            throw new Error("Should not have unsaved changes initially");
          }
          testResults.innerHTML += "<p>‚úÖ Change tracking works correctly</p>";

          // Test 5: Test patient update (mock form data)
          const updatedData = {
            ...testPatientData,
            firstName: "Jane",
            placeOfResidence: "Boston",
          };

          // Mock form manager for testing
          patientDetailView.formManager = {
            validateForm: () => ({ isValid: true, errors: {} }),
            getFormData: () => updatedData,
            markFormAsSaved: () => {},
            hasUnsavedChanges: () => false,
            destroyForm: () => {},
          };

          // Test save functionality
          await patientDetailView.handleSave();

          if (patientDetailView.isEditMode) {
            throw new Error("Should exit edit mode after save");
          }
          testResults.innerHTML += "<p>‚úÖ Save functionality works</p>";

          // Test 6: Verify patient was updated
          const updatedPatient = await patientManager.getPatient(
            createResult.patientId
          );
          if (updatedPatient.firstName !== "Jane") {
            throw new Error("Patient was not updated correctly");
          }
          testResults.innerHTML +=
            "<p>‚úÖ Patient data updated successfully</p>";

          // Test 7: Test cancel edit
          patientDetailView.handleEdit();
          patientDetailView.handleCancelEdit();
          if (patientDetailView.isEditMode) {
            throw new Error("Should exit edit mode after cancel");
          }
          testResults.innerHTML += "<p>‚úÖ Cancel edit works</p>";

          testResults.innerHTML +=
            "<p><strong>üéâ All Patient Modification Tests Passed!</strong></p>";

          // Clean up
          patientDetailView.destroy();
        } catch (error) {
          testResults.innerHTML += `<p style="color: red;">‚ùå Test failed: ${error.message}</p>`;
          console.error("Test error:", error);
        }
      }

      // Run tests when page loads
      window.addEventListener("load", testPatientModification);
    </script>
  </body>
</html>
