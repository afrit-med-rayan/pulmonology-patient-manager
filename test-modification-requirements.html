<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Modification Requirements Test</title>
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/base.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/components.css" />
    <style>
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .test-passed {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .test-failed {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .requirement {
        font-weight: bold;
        color: #0066cc;
      }
    </style>
  </head>
  <body>
    <div id="test-container">
      <h1>Patient Modification Requirements Verification</h1>
      <div id="test-results"></div>
      <div id="patient-detail-container"></div>
    </div>

    <!-- Load all required scripts -->
    <script src="js/utils/constants.js"></script>
    <script src="js/utils/helpers.js"></script>
    <script src="js/models/Patient.js"></script>
    <script src="js/components/DataStorageManager.js"></script>
    <script src="js/components/PatientManager.js"></script>
    <script src="js/components/FormManager.js"></script>
    <script src="js/components/PatientDetailView.js"></script>

    <script>
      // Test all patient modification requirements
      async function testModificationRequirements() {
        const testResults = document.getElementById("test-results");
        const container = document.getElementById("patient-detail-container");

        let passedTests = 0;
        let totalTests = 5; // Based on 5 acceptance criteria

        try {
          testResults.innerHTML =
            "<h2>üß™ Testing Patient Modification Requirements (Requirement 5)</h2>";

          // Initialize components
          const dataStorage = new DataStorageManager();
          await dataStorage.initializeStorage();

          const patientManager = new PatientManager();
          await patientManager.initialize(dataStorage);

          // Create test patient
          const testPatientData = {
            firstName: "John",
            lastName: "Doe",
            dateOfBirth: "1980-01-15",
            age: 44,
            placeOfResidence: "New York",
            gender: "male",
            visits: [
              {
                visitDate: "2024-01-15",
                medications: "Albuterol inhaler",
                observations: "Mild wheezing",
                additionalComments: "Patient reports improvement",
              },
            ],
          };

          const createResult = await patientManager.createPatient(
            testPatientData
          );
          const patient = await patientManager.getPatient(
            createResult.patientId
          );
          const patientDetailView = new PatientDetailView(
            patient,
            patientManager
          );

          // Test Requirement 5.1: WHEN viewing a patient record THEN the system SHALL provide an option to edit the record
          try {
            container.innerHTML = patientDetailView.render();
            const editButton = container.querySelector(".edit-button");

            if (editButton && editButton.textContent.includes("Edit Patient")) {
              testResults.innerHTML += `
                            <div class="test-section test-passed">
                                <div class="requirement">Requirement 5.1: ‚úÖ PASSED</div>
                                <p>System provides an "Edit Patient" button when viewing a patient record</p>
                            </div>
                        `;
              passedTests++;
            } else {
              throw new Error("Edit button not found or incorrectly labeled");
            }
          } catch (error) {
            testResults.innerHTML += `
                        <div class="test-section test-failed">
                            <div class="requirement">Requirement 5.1: ‚ùå FAILED</div>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
          }

          // Test Requirement 5.2: WHEN editing a patient record THEN the system SHALL allow modification of all patient fields
          try {
            patientDetailView.handleEdit();
            container.innerHTML = patientDetailView.render();

            // Check for all required form fields
            const requiredFields = [
              "firstName",
              "lastName",
              "dateOfBirth",
              "placeOfResidence",
              "gender",
            ];

            let allFieldsPresent = true;
            const missingFields = [];

            requiredFields.forEach((field) => {
              const input = container.querySelector(`[name="${field}"]`);
              if (!input) {
                allFieldsPresent = false;
                missingFields.push(field);
              }
            });

            // Check for visits section
            const visitsContainer =
              container.querySelector(".visits-container");
            if (!visitsContainer) {
              allFieldsPresent = false;
              missingFields.push("visits");
            }

            if (allFieldsPresent) {
              testResults.innerHTML += `
                            <div class="test-section test-passed">
                                <div class="requirement">Requirement 5.2: ‚úÖ PASSED</div>
                                <p>System allows modification of all patient fields including personal info and visits</p>
                            </div>
                        `;
              passedTests++;
            } else {
              throw new Error(`Missing fields: ${missingFields.join(", ")}`);
            }
          } catch (error) {
            testResults.innerHTML += `
                        <div class="test-section test-failed">
                            <div class="requirement">Requirement 5.2: ‚ùå FAILED</div>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
          }

          // Test Requirement 5.3: WHEN modifications are made THEN the system SHALL track that changes are pending
          try {
            // Mock form manager to simulate changes
            patientDetailView.formManager = {
              validateForm: () => ({ isValid: true, errors: {} }),
              getFormData: () => ({ ...testPatientData, firstName: "Jane" }),
              markFormAsSaved: () => {},
              hasUnsavedChanges: () => true, // Simulate unsaved changes
              destroyForm: () => {},
            };

            const hasChanges = patientDetailView.hasUnsavedChanges();

            if (hasChanges) {
              testResults.innerHTML += `
                            <div class="test-section test-passed">
                                <div class="requirement">Requirement 5.3: ‚úÖ PASSED</div>
                                <p>System correctly tracks pending changes</p>
                            </div>
                        `;
              passedTests++;
            } else {
              throw new Error("Change tracking not working");
            }
          } catch (error) {
            testResults.innerHTML += `
                        <div class="test-section test-failed">
                            <div class="requirement">Requirement 5.3: ‚ùå FAILED</div>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
          }

          // Test Requirement 5.4: WHEN the Save button is clicked THEN the system SHALL update the patient record locally
          try {
            const updatedData = {
              ...testPatientData,
              firstName: "Jane",
              placeOfResidence: "Boston",
            };

            // Update form manager to return updated data
            patientDetailView.formManager.getFormData = () => updatedData;
            patientDetailView.formManager.hasUnsavedChanges = () => false;

            // Mock successful save
            const originalUpdatePatient = patientManager.updatePatient;
            patientManager.updatePatient = async (id, data) => {
              return { success: true, patient: new Patient(data) };
            };

            await patientDetailView.handleSave();

            // Restore original method
            patientManager.updatePatient = originalUpdatePatient;

            if (!patientDetailView.isEditMode) {
              testResults.innerHTML += `
                            <div class="test-section test-passed">
                                <div class="requirement">Requirement 5.4: ‚úÖ PASSED</div>
                                <p>System successfully updates patient record and exits edit mode</p>
                            </div>
                        `;
              passedTests++;
            } else {
              throw new Error("Did not exit edit mode after save");
            }
          } catch (error) {
            testResults.innerHTML += `
                        <div class="test-section test-failed">
                            <div class="requirement">Requirement 5.4: ‚ùå FAILED</div>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
          }

          // Test Requirement 5.5: WHEN a record is updated THEN the system SHALL display a confirmation message "Record saved"
          try {
            // Mock the showToast method to capture the message
            let toastMessage = "";
            let toastType = "";

            patientDetailView.showToast = (message, type) => {
              toastMessage = message;
              toastType = type;
            };

            // Enter edit mode again
            patientDetailView.handleEdit();

            // Mock form manager
            patientDetailView.formManager = {
              validateForm: () => ({ isValid: true, errors: {} }),
              getFormData: () => ({ ...testPatientData, firstName: "Updated" }),
              markFormAsSaved: () => {},
              hasUnsavedChanges: () => false,
              destroyForm: () => {},
            };

            // Mock successful save
            patientManager.updatePatient = async (id, data) => {
              return { success: true, patient: new Patient(data) };
            };

            await patientDetailView.handleSave();

            if (
              toastMessage.toLowerCase().includes("updated") ||
              toastMessage.toLowerCase().includes("saved")
            ) {
              testResults.innerHTML += `
                            <div class="test-section test-passed">
                                <div class="requirement">Requirement 5.5: ‚úÖ PASSED</div>
                                <p>System displays confirmation message: "${toastMessage}"</p>
                            </div>
                        `;
              passedTests++;
            } else {
              throw new Error(
                `Expected save confirmation message, got: "${toastMessage}"`
              );
            }
          } catch (error) {
            testResults.innerHTML += `
                        <div class="test-section test-failed">
                            <div class="requirement">Requirement 5.5: ‚ùå FAILED</div>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
          }

          // Summary
          testResults.innerHTML += `
                    <div class="test-section" style="background-color: ${
                      passedTests === totalTests ? "#d4edda" : "#fff3cd"
                    }; border-color: ${
            passedTests === totalTests ? "#c3e6cb" : "#ffeaa7"
          };">
                        <h3>üìä Test Summary</h3>
                        <p><strong>Passed:</strong> ${passedTests}/${totalTests} requirements</p>
                        <p><strong>Success Rate:</strong> ${(
                          (passedTests / totalTests) *
                          100
                        ).toFixed(1)}%</p>
                        ${
                          passedTests === totalTests
                            ? '<p style="color: green; font-weight: bold;">üéâ All patient modification requirements are implemented correctly!</p>'
                            : '<p style="color: orange; font-weight: bold;">‚ö†Ô∏è Some requirements need attention.</p>'
                        }
                    </div>
                `;

          // Clean up
          patientDetailView.destroy();
        } catch (error) {
          testResults.innerHTML += `<p style="color: red;">‚ùå Test setup failed: ${error.message}</p>`;
          console.error("Test error:", error);
        }
      }

      // Run tests when page loads
      window.addEventListener("load", testModificationRequirements);
    </script>
  </body>
</html>
